<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Khoa D∆∞·ª£c</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .nav-pills .nav-link.active { background-color: #0f9d58; }
        .nav-pills .nav-link { color: #555; font-weight: 600; }
        
        /* Style cho Badge tr·∫°ng th√°i */
        .badge-status { font-size: 0.85rem; padding: 6px 12px; border-radius: 30px; }
        .bg-todo { background-color: #dc3545; color: white; } /* ƒê·ªè */
        .bg-doing { background-color: #ffc107; color: #333; } /* V√†ng */
        .bg-done { background-color: #198754; color: white; } /* Xanh */

        /* Style cho thanh ti·∫øn ƒë·ªô nh·ªè trong b·∫£ng */
        .progress-sm { height: 10px; border-radius: 5px; margin-top: 5px; }
        
        /* Card shadow */
        .card-custom { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-radius: 10px; }
    </style>
</head>
<body>

<div class="container py-4">
    <h3 class="text-center text-success fw-bold mb-4">üè• QU·∫¢N L√ù C√îNG VI·ªÜC KHOA D∆Ø·ª¢C</h3>

    <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded shadow-sm" id="pills-tab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-input">üìù Giao Vi·ªác</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-list" onclick="loadTaskList()">üìã Danh S√°ch & L·ªçc</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-report" onclick="loadDashboard()">üìä B√°o C√°o T·ªïng H·ª£p</button>
        </li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="pills-input">
            <div class="card card-custom p-4">
                <form id="taskForm">
                    <div class="mb-3">
                        <label class="fw-bold">T√™n c√¥ng vi·ªác</label>
                        <input type="text" class="form-control" name="taskName" required placeholder="Nh·∫≠p t√™n ƒë·∫ßu vi·ªác...">
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">Ng∆∞·ªùi th·ª±c hi·ªán</label>
                            <select class="form-select" name="assignee" required>
                                <option value="" disabled selected>-- Ch·ªçn nh√¢n s·ª± --</option>
                                <optgroup label="‚≠ê L√£nh ƒë·∫°o Khoa">
                                    <option value="Nguy·ªÖn Th·ªã H∆∞∆°ng Giang">DS.CKII Nguy·ªÖn Th·ªã H∆∞∆°ng Giang</option>
                                    <option value="Tr·∫ßn Th·ªã Huy·ªÅn Trang">DS.CKI Tr·∫ßn Th·ªã Huy·ªÅn Trang</option>
                                </optgroup>
                                <optgroup label="üíä T·ªï D∆∞·ª£c L√¢m S√†ng">
                                    <option value="Nguy·ªÖn Th·ªã H∆∞∆°ng Giang">Nguy·ªÖn Th·ªã H∆∞∆°ng Giang (T·ªï tr∆∞·ªüng)</option>
                                    <option value="Ph·∫°m B√° Th∆∞∆°ng">Ph·∫°m B√° Th∆∞∆°ng</option>
                                    <option value="Chu ƒê√†i Trang">Chu ƒê√†i Trang</option>
                                    <option value="L√™ Th·ªã Thanh Nh√†n">L√™ Th·ªã Thanh Nh√†n</option>
                                </optgroup>
                                <optgroup label="üì¶ T·ªï Kho">
                                    <option value="Nguy·ªÖn Duy Ti·∫øn">Nguy·ªÖn Duy Ti·∫øn (T·ªï tr∆∞·ªüng)</option>
                                    <option value="Nguy·ªÖn Th·ªã H·∫±ng">Nguy·ªÖn Th·ªã H·∫±ng</option>
                                    <option value="Ki·ªÅu M·∫°nh To√†n">Ki·ªÅu M·∫°nh To√†n</option>
                                    <option value="ƒê·ªó Th·ªã Nh·∫≠t L·ªá">ƒê·ªó Th·ªã Nh·∫≠t L·ªá</option>
                                    <option value="H√† Th·ªã Th·∫£o">H√† Th·ªã Th·∫£o</option>
                                    <option value="Nguy·ªÖn Tu·∫•n Th√†nh">Nguy·ªÖn Tu·∫•n Th√†nh</option>
                                    <option value="Nguy·ªÖn Th·ªã Thu H√†">Nguy·ªÖn Th·ªã Thu H√†</option>
                                </optgroup>
                                <optgroup label="üìä T·ªï Th·ªëng k√™ - Nghi·ªáp v·ª•">
                                    <option value="Tr·∫ßn Th·ªã Huy·ªÅn Trang">Tr·∫ßn Th·ªã Huy·ªÅn Trang (T·ªï tr∆∞·ªüng)</option>
                                    <option value="V≈© Th·ªã H·ªìng H·∫°nh">V≈© Th·ªã H·ªìng H·∫°nh</option>
                                </optgroup>
                                <optgroup label="üöö T·ªï Cung ·ª©ng">
                                    <option value="Nguy·ªÖn Th·ªã H∆∞∆°ng Giang">Nguy·ªÖn Th·ªã H∆∞∆°ng Giang</option>
                                    <option value="Tr·∫ßn Th·ªã Huy·ªÅn Trang">Tr·∫ßn Th·ªã Huy·ªÅn Trang</option>
                                    <option value="L√™ Th·ªã Thanh Nh√†n">L√™ Th·ªã Thanh Nh√†n</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">Tr·∫°ng th√°i</label>
                            <select class="form-select" name="status">
                                <option value="Todo">Todo (Ch·ªù)</option>
                                <option value="Doing" selected>Doing (ƒêang l√†m)</option>
                                <option value="Done">Done (Xong)</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">∆Øu ti√™n</label>
                            <select class="form-select" name="priority">
                                <option value="P1">üî¥ Cao</option>
                                <option value="P2" selected>üü° TB</option>
                                <option value="P3">üü¢ Th·∫•p</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">Deadline</label>
                            <input type="date" class="form-control" name="deadline">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold">Ti·∫øn ƒë·ªô: <span id="progressVal" class="text-success fw-bold">0%</span></label>
                        <input type="range" class="form-range" name="progress" min="0" max="100" step="10" value="0" oninput="document.getElementById('progressVal').innerText = this.value + '%'">
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold">Ghi ch√∫</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>

                    <button type="submit" class="btn btn-success w-100 fw-bold py-2" id="submitBtn">L∆ØU C√îNG VI·ªÜC</button>
                    <div id="message" class="text-center mt-2 fw-bold"></div>
                </form>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-list">
            <div class="card card-custom p-3">
                
                <div class="row g-2 mb-3 bg-light p-3 rounded">
                    <div class="col-md-4">
                        <label class="form-label fw-bold small">üîç L·ªçc theo t√™n ng∆∞·ªùi</label>
                        <select id="filterAssignee" class="form-select form-select-sm" onchange="renderTable()">
                            <option value="">-- T·∫•t c·∫£ nh√¢n vi√™n --</option>
                            </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">üìå L·ªçc tr·∫°ng th√°i</label>
                        <select id="filterStatus" class="form-select form-select-sm" onchange="renderTable()">
                            <option value="">-- T·∫•t c·∫£ --</option>
                            <option value="Todo">Todo (Ch∆∞a l√†m)</option>
                            <option value="Doing">Doing (ƒêang l√†m)</option>
                            <option value="Done">Done (Ho√†n th√†nh)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                         <label class="form-label fw-bold small">üìÖ T√¨m t√™n vi·ªác</label>
                         <input type="text" id="filterText" class="form-control form-control-sm" placeholder="Nh·∫≠p t·ª´ kh√≥a..." onkeyup="renderTable()">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary btn-sm w-100" onclick="loadTaskList()">üîÑ T·∫£i l·∫°i</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle border">
                        <thead class="table-light">
                            <tr>
                                <th width="35%">C√¥ng vi·ªác / Ti·∫øn ƒë·ªô</th>
                                <th width="20%">Ng∆∞·ªùi l√†m</th>
                                <th width="15%">H·∫°n ch√≥t</th>
                                <th width="15%">Tr·∫°ng th√°i</th>
                                <th width="15%">X√°c nh·∫≠n</th>
                            </tr>
                        </thead>
                        <tbody id="taskTableBody">
                            <tr><td colspan="5" class="text-center py-4">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-report">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card card-custom p-3 h-100">
                        <h6 class="text-center text-secondary fw-bold">T·ªâ l·ªá ho√†n th√†nh c√¥ng vi·ªác</h6>
                        <div id="piechart" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card card-custom p-3 h-100">
                        <h6 class="text-center text-secondary fw-bold">S·ªë l∆∞·ª£ng vi·ªác ƒë∆∞·ª£c giao</h6>
                        <div id="barchart_count" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-outline-primary" onclick="loadDashboard()">üîÑ C·∫≠p nh·∫≠t b√°o c√°o</button>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- C·∫§U H√åNH ---
    // H√ÉY D√ÅN LINK WEB APP C·ª¶A B·∫†N V√ÄO D∆Ø·ªöI ƒê√ÇY
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_9NKQHyVrnuNHs4hzRElnEpLILt6bubcMZkle6CUvo9NmV0VtXeulm_g7HzJnC7MqyQ/exec"; 

    // Bi·∫øn to√†n c·ª•c l∆∞u d·ªØ li·ªáu ƒë·ªÉ l·ªçc kh√¥ng c·∫ßn g·ªçi l·∫°i API
    let globalData = [];

    // 1. G·ª¨I FORM (ADD TASK)
    document.getElementById('taskForm').addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn'); btn.disabled = true; btn.innerText = "ƒêang l∆∞u...";
        
        const formData = new FormData(document.getElementById('taskForm'));
        const data = Object.fromEntries(formData.entries());

        fetch(SCRIPT_URL + "?action=add", { method: 'POST', body: JSON.stringify(data) })
        .then(r => r.json()).then(res => {
            if(res.status === 'success') {
                alert("‚úÖ " + res.message);
                document.getElementById('taskForm').reset();
                document.getElementById('progressVal').innerText = "0%";
            } else { alert("L·ªói: " + res.message); }
        })
        .catch(err => alert("L·ªói k·∫øt n·ªëi!"))
        .finally(() => { btn.disabled = false; btn.innerText = "L∆ØU C√îNG VI·ªÜC"; });
    });

    // 2. T·∫¢I D·ªÆ LI·ªÜU & RENDER DANH S√ÅCH
    function loadTaskList() {
        if(SCRIPT_URL.includes("D√ÅN_LINK")) { alert("Ch∆∞a d√°n Link API!"); return; }
        document.getElementById('taskTableBody').innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-success"></div><br>ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

        fetch(SCRIPT_URL + "?action=read")
        .then(r => r.json()).then(res => {
            globalData = res.data; // L∆∞u v√†o bi·∫øn to√†n c·ª•c
            populateAssigneeFilter(globalData); // ƒêi·ªÅn t√™n v√†o b·ªô l·ªçc
            renderTable(); // V·∫Ω b·∫£ng
        });
    }

    // H√†m ƒëi·ªÅn t√™n nh√¢n vi√™n v√†o √¥ l·ªçc t·ª± ƒë·ªông
    function populateAssigneeFilter(data) {
        const select = document.getElementById('filterAssignee');
        const currentVal = select.value;
        const people = [...new Set(data.map(row => row[7]).filter(n => n))].sort();
        
        select.innerHTML = '<option value="">-- T·∫•t c·∫£ nh√¢n vi√™n --</option>';
        people.forEach(p => {
            select.innerHTML += `<option value="${p}">${p}</option>`;
        });
        select.value = currentVal;
    }

    // H√†m v·∫Ω b·∫£ng (C√≥ √°p d·ª•ng l·ªçc)
    function renderTable() {
        const tbody = document.getElementById('taskTableBody');
        tbody.innerHTML = "";
        
        const fName = document.getElementById('filterAssignee').value;
        const fStatus = document.getElementById('filterStatus').value;
        const fText = document.getElementById('filterText').value.toLowerCase();

        // L·ªçc d·ªØ li·ªáu
        let filteredData = globalData.filter(row => {
            let assignee = row[7] || "";
            let status = row[2] || "";
            let taskName = (row[1] || "").toLowerCase();
            
            return (fName === "" || assignee === fName) &&
                   (fStatus === "" || status === fStatus) &&
                   (fText === "" || taskName.includes(fText));
        });

        filteredData.sort((a,b) => (a[2] === 'Done') - (b[2] === 'Done'));

        if(filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác n√†o.</td></tr>';
            return;
        }

        filteredData.forEach(row => {
            // row: [ID, Name, Status, Priority, Deadline, Note, Time, Assignee, Progress]
            let id = row[0];
            let name = row[1];
            let status = row[2];
            let deadline = row[4] ? new Date(row[4]).toLocaleDateString('vi-VN') : '';
            let assignee = row[7];
            let progressStr = row[8] ? row[8].replace('%','') : '0';
            let progress = parseInt(progressStr);

            let badgeClass = status === 'Done' ? 'bg-done' : (status === 'Doing' ? 'bg-doing' : 'bg-todo');
            let barColor = progress === 100 ? 'bg-success' : (progress < 50 ? 'bg-danger' : 'bg-warning');

            let actionBtn = status !== 'Done' 
                ? `<button class="btn btn-outline-success btn-sm" onclick="markAsDone('${id}')">‚úÖ Xong</button>` 
                : `<span class="text-success fw-bold">‚úì</span>`;

            let tr = `<tr>
                <td>
                    <div class="fw-bold text-primary">${name}</div>
                    <small class="text-muted d-block fst-italic">${row[5]}</small>
                    <div class="progress progress-sm w-100 bg-secondary-subtle">
                        <div class="progress-bar ${barColor}" style="width: ${progress}%"></div>
                    </div>
                    <small style="font-size:10px;">Ti·∫øn ƒë·ªô: ${progress}%</small>
                </td>
                <td><span class="fw-bold">${assignee}</span></td>
                <td>${deadline}</td>
                <td><span class="badge badge-status ${badgeClass}">${status}</span></td>
                <td>${actionBtn}</td>
            </tr>`;
            tbody.innerHTML += tr;
        });
    }

    // 3. ƒê√ÅNH D·∫§U HO√ÄN TH√ÄNH
    function markAsDone(taskId) {
        if (!confirm("X√°c nh·∫≠n ho√†n th√†nh 100% c√¥ng vi·ªác n√†y?")) return;
        const btn = event.target; btn.innerText = "..."; btn.disabled = true;

        fetch(SCRIPT_URL + "?action=update", {
            method: 'POST', body: JSON.stringify({ id: taskId })
        }).then(r => r.json()).then(res => {
            alert(res.message);
            loadTaskList(); 
        });
    }

    // 4. B√ÅO C√ÅO & BI·ªÇU ƒê·ªí (DASHBOARD)
    google.charts.load('current', {'packages':['corechart', 'bar']});
    
    function loadDashboard() {
        if(SCRIPT_URL.includes("D√ÅN_LINK")) { alert("Ch∆∞a d√°n Link API!"); return; }
        fetch(SCRIPT_URL + "?action=read").then(r => r.json()).then(res => {
            drawCharts(res.data);
        });
    }

    function drawCharts(data) {
        if(!data || data.length === 0) return;

        var statusCount = {'Todo': 0, 'Doing': 0, 'Done': 0};
        var personStats = {}; 

        data.forEach(row => {
            let status = row[2];
            let person = row[7];
            
            // Pie data
            if(statusCount[status] !== undefined) statusCount[status]++;

            // Person data
            if(person) {
                if(!personStats[person]) personStats[person] = { count: 0 };
                personStats[person].count++;
            }
        });

        // --- V·∫º PIE CHART (TR·∫†NG TH√ÅI) ---
        var pieData = google.visualization.arrayToDataTable([
            ['Tr·∫°ng th√°i', 'S·ªë l∆∞·ª£ng'],
            ['Todo', statusCount['Todo']], ['Doing', statusCount['Doing']], ['Done', statusCount['Done']]
        ]);
        new google.visualization.PieChart(document.getElementById('piechart')).draw(pieData, {
            colors: ['#dc3545', '#ffc107', '#198754'], is3D: true, legend: {position:'bottom'}
        });

        // --- V·∫º BAR CHART (S·ªê L∆Ø·ª¢NG VI·ªÜC) ---
        var countArray = [['Nh√¢n vi√™n', 'S·ªë vi·ªác', { role: 'style' }]];
        Object.keys(personStats).sort().forEach(p => {
            countArray.push([p, personStats[p].count, '#0d6efd']);
        });
        new google.visualization.ColumnChart(document.getElementById('barchart_count')).draw(
            google.visualization.arrayToDataTable(countArray), 
            { legend: { position: "none" }, vAxis: {title: 'S·ªë l∆∞·ª£ng ƒë·∫ßu vi·ªác'} }
        );
    }
</script>

</body>
</html>
