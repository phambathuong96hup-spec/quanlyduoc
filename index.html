<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Khoa D∆∞·ª£c</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; font-size: 14px; }
        .nav-pills .nav-link.active { background-color: #0f9d58; }
        .nav-pills .nav-link { color: #555; font-weight: 600; }
        
        /* Badge Status */
        .badge-status { font-size: 0.8rem; padding: 5px 10px; border-radius: 20px; }
        .bg-todo { background-color: #dc3545; color: white; } 
        .bg-doing { background-color: #ffc107; color: #333; } 
        .bg-done { background-color: #198754; color: white; } 
        
        /* Card & Calendar */
        .card-custom { border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-radius: 12px; }
        #calendar { max-width: 100%; margin: 0 auto; min-height: 800px; font-family: Arial, sans-serif; }
        .fc-toolbar-title { font-size: 1.5em !important; color: #0f9d58; font-weight: bold; }
        .fc-day-today { background-color: #e8f5e9 !important; }

        /* Style cho thanh tr∆∞·ª£t trong b·∫£ng */
        .range-slider { width: 100%; cursor: pointer; height: 6px; }
    </style>
</head>
<body>

<div class="container-fluid px-4 py-4" style="max-width: 1400px;">
    <h3 class="text-center text-success fw-bold mb-4">üè• QU·∫¢N L√ù C√îNG VI·ªÜC KHOA D∆Ø·ª¢C</h3>

    <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded shadow-sm" id="pills-tab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-input">üìù Giao Vi·ªác</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-list" onclick="loadTaskList()">üìã Danh S√°ch & C·∫≠p Nh·∫≠t</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-report" onclick="loadDashboard()">üìä B√°o C√°o & L·ªãch</button></li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="pills-input">
            <div class="container" style="max-width: 800px;">
                <div class="card card-custom p-4">
                    <form id="taskForm">
                        <div class="mb-3"><label class="fw-bold">T√™n c√¥ng vi·ªác</label><input type="text" class="form-control" name="taskName" required placeholder="Nh·∫≠p t√™n ƒë·∫ßu vi·ªác..."></div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="fw-bold">Ng∆∞·ªùi th·ª±c hi·ªán</label>
                                <select class="form-select" name="assignee" id="assigneeSelect" required>
                                    <option value="" disabled selected>-- Ch·ªçn nh√¢n s·ª± --</option>
                                    <optgroup label="‚≠ê L√£nh ƒë·∫°o Khoa">
                                        <option value="Nguy·ªÖn Th·ªã H∆∞∆°ng Giang">DS.CKI Nguy·ªÖn Th·ªã H∆∞∆°ng Giang</option>
                                        <option value="Tr·∫ßn Th·ªã Huy·ªÅn Trang">DSƒêH Tr·∫ßn Th·ªã Huy·ªÅn Trang</option>
                                    </optgroup>
                                    <optgroup label="üíä T·ªï D∆∞·ª£c L√¢m S√†ng">
                                        <option value="Nguy·ªÖn Th·ªã H∆∞∆°ng Giang">DSƒêH Nguy·ªÖn Th·ªã H∆∞∆°ng Giang (T·ªï tr∆∞·ªüng)</option>
                                        <option value="Ph·∫°m B√° Th∆∞∆°ng">DSƒêH Ph·∫°m B√° Th∆∞∆°ng</option>
                                        <option value="Chu ƒê√†i Trang">DS.CKI Chu ƒê√†i Trang</option>
                                        <option value="L√™ Th·ªã Thanh Nh√†n">DSƒêH L√™ Th·ªã Thanh Nh√†n</option>
                                    </optgroup>
                                    <optgroup label="üì¶ T·ªï Kho">
                                        <option value="Nguy·ªÖn Duy Ti·∫øn">DSƒêH Nguy·ªÖn Duy Ti·∫øn (T·ªï tr∆∞·ªüng)</option>
                                        <option value="Nguy·ªÖn Th·ªã H·∫±ng">DSƒêH Nguy·ªÖn Th·ªã H·∫±ng</option>
                                        <option value="Ki·ªÅu M·∫°nh To√†n">DSƒêH Ki·ªÅu M·∫°nh To√†n</option>
                                        <option value="ƒê·ªó Th·ªã Nh·∫≠t L·ªá">DSƒêH ƒê·ªó Th·ªã Nh·∫≠t L·ªá</option>
                                        <option value="H√† Th·ªã Th·∫£o">DS H√† Th·ªã Th·∫£o</option>
                                        <option value="Nguy·ªÖn Tu·∫•n Th√†nh">DS Nguy·ªÖn Tu·∫•n Th√†nh</option>
                                        <option value="Nguy·ªÖn Th·ªã Thu H√†">DSƒêH Nguy·ªÖn Th·ªã Thu H√†</option>
                                    </optgroup>
                                    <optgroup label="üìä T·ªï Th·ªëng k√™ - NV">
                                        <option value="Tr·∫ßn Th·ªã Huy·ªÅn Trang">DSƒêH Tr·∫ßn Th·ªã Huy·ªÅn Trang (T·ªï tr∆∞·ªüng)</option>
                                        <option value="V≈© Th·ªã H·ªìng H·∫°nh">DSƒêH V≈© Th·ªã H·ªìng H·∫°nh</option>
                                    </optgroup>
                                    <optgroup label="üöö T·ªï Cung ·ª©ng">
                                        <option value="Nguy·ªÖn Th·ªã H∆∞∆°ng Giang">DS.CKI Nguy·ªÖn Th·ªã H∆∞∆°ng Giang</option>
                                        <option value="Tr·∫ßn Th·ªã Huy·ªÅn Trang">DSƒêH Tr·∫ßn Th·ªã Huy·ªÅn Trang</option>
                                        <option value="L√™ Th·ªã Thanh Nh√†n">DSƒêH L√™ Th·ªã Thanh Nh√†n</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3"><label class="fw-bold">Tr·∫°ng th√°i ban ƒë·∫ßu</label>
                                <select class="form-select" name="status">
                                    <option value="Todo" selected>Todo (Ch·ªù)</option>
                                    <option value="Doing">Doing (ƒêang l√†m)</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="fw-bold">∆Øu ti√™n</label><select class="form-select" name="priority"><option value="P1">üî¥ Cao</option><option value="P2" selected>üü° TB</option><option value="P3">üü¢ Th·∫•p</option></select></div>
                            <div class="col-md-6 mb-3"><label class="fw-bold">Deadline</label><input type="date" class="form-control" name="deadline"></div>
                        </div>

                        <div class="mb-3"><label class="fw-bold">Ghi ch√∫</label><textarea class="form-control" name="notes" rows="2"></textarea></div>

                        <button type="submit" class="btn btn-success w-100 fw-bold py-2" id="submitBtn">L∆ØU C√îNG VI·ªÜC</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-list">
            <div class="card card-custom p-3">
                <div class="row g-2 mb-3 bg-light p-3 rounded mx-0">
                    <div class="col-md-4"><select id="filterAssignee" class="form-select form-select-sm" onchange="renderTable()"><option value="">-- T·∫•t c·∫£ nh√¢n vi√™n --</option></select></div>
                    <div class="col-md-3"><select id="filterStatus" class="form-select form-select-sm" onchange="renderTable()"><option value="">-- T·∫•t c·∫£ TT --</option><option value="Todo">Todo</option><option value="Doing">Doing</option><option value="Done">Done</option></select></div>
                    <div class="col-md-3"><input type="text" id="filterText" class="form-control form-control-sm" placeholder="T√¨m vi·ªác..." onkeyup="renderTable()"></div>
                    <div class="col-md-2"><button class="btn btn-primary btn-sm w-100" onclick="loadTaskList()">üîÑ T·∫£i l·∫°i</button></div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle border">
                        <thead class="table-light">
                            <tr>
                                <th width="20%">C√¥ng vi·ªác</th>
                                <th width="20%">Ti·∫øn ƒë·ªô (K√©o ch·ªânh)</th> <th width="15%">Ng∆∞·ªùi l√†m</th>
                                <th width="10%">Ng√†y t·∫°o</th>
                                <th width="10%">Deadline</th>
                                <th width="10%">Tr·∫°ng th√°i</th>
                                <th width="15%">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="taskTableBody">
                            <tr><td colspan="7" class="text-center py-4">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-report">
            <div class="row g-3 mb-4">
                <div class="col-md-6"><div class="card card-custom p-3 h-100"><div id="piechart" style="height:300px;"></div></div></div>
                <div class="col-md-6"><div class="card card-custom p-3 h-100"><div id="barchart_count" style="height:300px;"></div></div></div>
            </div>
            
            <div class="card card-custom p-4">
                <h5 class="text-success fw-bold mb-3">üìÖ L·ªäCH DEADLINE C√îNG VI·ªÜC</h5>
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- C·∫§U H√åNH ---
    // Gi·ªØ nguy√™n link script c·ªßa b·∫°n
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_9NKQHyVrnuNHs4hzRElnEpLILt6bubcMZkle6CUvo9NmV0VtXeulm_g7HzJnC7MqyQ/exec"; 
    
    let globalData = [];

    // 1. G·ª¨I FORM (ADD TASK)
    document.getElementById('taskForm').addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn'); btn.disabled = true; btn.innerText = "ƒêang l∆∞u...";
        
        // L·∫•y d·ªØ li·ªáu form
        const formData = new FormData(document.getElementById('taskForm'));
        const data = Object.fromEntries(formData.entries());

        fetch(SCRIPT_URL + "?action=add", { method: 'POST', body: JSON.stringify(data) })
        .then(r => r.json()).then(res => {
            if(res.status === 'success') {
                alert("‚úÖ " + res.message);
                document.getElementById('taskForm').reset();
                // Chuy·ªÉn sang tab danh s√°ch
                document.querySelector('[data-bs-target="#pills-list"]').click();
            } else { alert("L·ªói: " + res.message); }
        })
        .catch(err => alert("L·ªói k·∫øt n·ªëi!"))
        .finally(() => { btn.disabled = false; btn.innerText = "L∆ØU C√îNG VI·ªÜC"; });
    });

    // 2. T·∫¢I D·ªÆ LI·ªÜU
    function loadTaskList() {
        if(SCRIPT_URL.includes("D√ÅN_LINK")) { alert("Ch∆∞a d√°n Link API!"); return; }
        const tbody = document.getElementById('taskTableBody');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-success"></div><br>ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

        fetch(SCRIPT_URL + "?action=read").then(r => r.json()).then(res => {
            globalData = res.data; populateAssigneeFilter(globalData); renderTable();
        });
    }

    function populateAssigneeFilter(data) {
        const select = document.getElementById('filterAssignee');
        const currentVal = select.value;
        const people = [...new Set(data.map(row => String(row[7] || "").trim()).filter(n => n))].sort();
        select.innerHTML = '<option value="">-- T·∫•t c·∫£ nh√¢n vi√™n --</option>';
        people.forEach(p => select.innerHTML += `<option value="${p}">${p}</option>`);
        select.value = currentVal;
    }

    // 3. V·∫º B·∫¢NG (V·ªöI THANH K√âO TI·∫æN ƒê·ªò)
    function renderTable() {
        const tbody = document.getElementById('taskTableBody'); tbody.innerHTML = "";
        
        const fName = document.getElementById('filterAssignee').value.toLowerCase().trim();
        const fStatus = document.getElementById('filterStatus').value;
        const fText = document.getElementById('filterText').value.toLowerCase().trim();

        let filteredData = globalData.filter(row => {
            let assignee = String(row[7] || "").toLowerCase().trim();
            let status = String(row[2] || "").trim();
            let taskName = String(row[1] || "").toLowerCase();
            let matchStatus = fStatus === "" || (status.toLowerCase() === fStatus.toLowerCase());
            return (fName === "" || assignee === fName) && matchStatus && (fText === "" || taskName.includes(fText));
        });

        filteredData.sort((a,b) => (String(a[2]).trim() === 'Done') - (String(b[2]).trim() === 'Done'));

        filteredData.forEach(row => {
            // Index: 0:ID, 1:Name, 2:Status, 3:Priority, 4:Deadline, 5:Note, 6:CreatedDate, 7:Assignee, 8:Progress
            let id = row[0];
            let name = row[1];
            let rawStatus = String(row[2] || "").trim();
            let deadline = row[4] ? new Date(row[4]).toLocaleDateString('vi-VN') : '';
            let createdDate = row[6] ? new Date(row[6]).toLocaleDateString('vi-VN') : '';
            let assignee = row[7];
            let progress = parseInt(String(row[8] || "0").replace('%','')) || 0;

            let badgeClass = rawStatus === 'Done' ? 'bg-done' : (rawStatus === 'Doing' ? 'bg-doing' : 'bg-todo');

            // N√∫t Done
            let doneBtn = rawStatus !== 'Done' 
                ? `<button class="btn btn-outline-success btn-sm w-100" onclick="markAsDone('${id}')">‚úÖ Xong</button>` 
                : `<span class="text-success fw-bold">‚úì</span>`;

            // THANH TR∆Ø·ª¢T TI·∫æN ƒê·ªò (LOGIC M·ªöI)
            let sliderHTML = '';
            if(rawStatus === 'Done') {
                sliderHTML = `<div class="progress" style="height: 20px;"><div class="progress-bar bg-success" style="width: 100%">100%</div></div>`;
            } else {
                sliderHTML = `
                    <div class="d-flex align-items-center">
                        <input type="range" class="range-slider form-range me-2" min="0" max="100" step="10" value="${progress}" 
                            onchange="updateProgress('${id}', this.value)" 
                            title="K√©o ƒë·ªÉ c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô">
                        <span class="badge bg-secondary" id="val-${id}" style="min-width: 40px;">${progress}%</span>
                    </div>`;
            }

            tbody.innerHTML += `<tr>
                <td><div class="fw-bold text-primary">${name}</div><small class="text-muted fst-italic">${row[5] || ''}</small></td>
                <td>${sliderHTML}</td>
                <td><span class="fw-bold">${assignee}</span></td>
                <td><small>${createdDate}</small></td>
                <td>${deadline}</td>
                <td><span class="badge badge-status ${badgeClass}">${rawStatus}</span></td>
                <td><div class="d-flex flex-column gap-1">${doneBtn}</div></td>
            </tr>`;
        });
    }

    // 4. H√ÄM C·∫¨P NH·∫¨T TI·∫æN ƒê·ªò (M·ªöI)
    function updateProgress(id, value) {
        document.getElementById(`val-${id}`).innerText = value + "%";
        
        fetch(SCRIPT_URL + "?action=update_progress", {
            method: 'POST',
            body: JSON.stringify({ id: id, progress: value })
        })
        .then(r => r.json())
        .then(res => {
            console.log(res.message);
            // N·∫øu k√©o 100% th√¨ reload l·∫°i b·∫£ng ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh Done
            if(value == 100) loadTaskList(); 
        })
        .catch(err => alert("L·ªói k·∫øt n·ªëi!"));
    }

    function markAsDone(taskId) {
        if (!confirm("X√°c nh·∫≠n ho√†n th√†nh?")) return;
        fetch(SCRIPT_URL + "?action=update", { method: 'POST', body: JSON.stringify({ id: taskId }) })
        .then(r => r.json()).then(res => { alert(res.message); loadTaskList(); });
    }

    // 5. B√ÅO C√ÅO & L·ªäCH
    google.charts.load('current', {'packages':['corechart', 'bar']});
    function loadDashboard() {
        if(SCRIPT_URL.includes("D√ÅN_LINK")) return;
        fetch(SCRIPT_URL + "?action=read").then(r => r.json()).then(res => {
            drawCharts(res.data);
            renderCalendar(res.data);
        });
    }

    function drawCharts(data) {
        if(!data || data.length === 0) return;
        var statusCount = {'Todo': 0, 'Doing': 0, 'Done': 0};
        var personStats = {}; 
        data.forEach(row => {
            let status = String(row[2] || "").trim();
            let person = row[7];
            if(statusCount[status] !== undefined) statusCount[status]++; else statusCount['Doing'] = (statusCount['Doing'] || 0) + 1;
            if(person) { if(!personStats[person]) personStats[person] = { count: 0 }; personStats[person].count++; }
        });
        new google.visualization.PieChart(document.getElementById('piechart')).draw(google.visualization.arrayToDataTable([['S','C'],['Todo',statusCount['Todo']],['Doing',statusCount['Doing']],['Done',statusCount['Done']]]),{colors:['#dc3545','#ffc107','#198754'],is3D:true,legend:{position:'bottom'}});
        var cA = [['NV','S·ªë vi·ªác',{role:'style'}]]; Object.keys(personStats).sort().forEach(p=>cA.push([p,personStats[p].count,'#0d6efd']));
        new google.visualization.ColumnChart(document.getElementById('barchart_count')).draw(google.visualization.arrayToDataTable(cA),{legend:{position:"none"}});
    }

    // H√ÄM V·∫º L·ªäCH (ƒê√É TH√äM V√ÄO)
    function renderCalendar(data) {
        var calendarEl = document.getElementById('calendar');
        var events = data.map(row => {
            let name = row[1]; let status = String(row[2] || "").trim(); let deadline = row[4]; let assignee = row[7];
            let color = '#3788d8'; if(status==='Done') color='#198754'; else if(status==='Todo') color='#dc3545'; else if(status==='Doing') color='#ffc107';
            if(deadline) { let d=new Date(deadline).toISOString().split('T')[0]; return { title: `${name} (${assignee})`, start: d, color: color, textColor: status==='Doing'?'black':'white' }; } return null;
        }).filter(e=>e!==null);
        
        if(window.myCalendar) { 
            window.myCalendar.removeAllEvents(); 
            window.myCalendar.addEventSource(events); 
        } else {
            window.myCalendar = new FullCalendar.Calendar(calendarEl, { 
                initialView: 'dayGridMonth', 
                locale: 'vi', 
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' }, 
                height: 800, 
                events: events, 
                eventClick: function(i){ alert(i.event.title + '\nDeadline: ' + i.event.start.toLocaleDateString('vi-VN')); } 
            });
            window.myCalendar.render(); 
            setTimeout(()=>{window.myCalendar.updateSize()},200);
        }
    }
</script>
</body>
</html>
