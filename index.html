<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Khoa D∆∞·ª£c</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .nav-pills .nav-link.active { background-color: #0f9d58; }
        .nav-pills .nav-link { color: #555; font-weight: 600; }
        
        /* Style cho Badge tr·∫°ng th√°i */
        .badge-status { font-size: 0.85rem; padding: 6px 12px; border-radius: 30px; }
        .bg-todo { background-color: #dc3545; color: white; } /* ƒê·ªè */
        .bg-doing { background-color: #ffc107; color: #333; } /* V√†ng */
        .bg-done { background-color: #198754; color: white; } /* Xanh */

        /* Style cho thanh ti·∫øn ƒë·ªô nh·ªè trong b·∫£ng */
        .progress-sm { height: 10px; border-radius: 5px; margin-top: 5px; }
        
        /* Card shadow */
        .card-custom { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-radius: 10px; }
    </style>
</head>
<body>

<div class="container py-4">
    <h3 class="text-center text-success fw-bold mb-4">üè• QU·∫¢N L√ù C√îNG VI·ªÜC KHOA D∆Ø·ª¢C</h3>

    <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded shadow-sm" id="pills-tab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-input">üìù Giao Vi·ªác</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-list" onclick="loadTaskList()">üìã Danh S√°ch & L·ªçc</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-report" onclick="loadDashboard()">üìä B√°o C√°o T·ªïng H·ª£p</button>
        </li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="pills-input">
            <div class="card card-custom p-4">
                <form id="taskForm">
                    <div class="mb-3">
                        <label class="fw-bold">T√™n c√¥ng vi·ªác</label>
                        <input type="text" class="form-control" name="taskName" required placeholder="Nh·∫≠p t√™n ƒë·∫ßu vi·ªác...">
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">Ng∆∞·ªùi th·ª±c hi·ªán</label>
                            <select class="form-select" name="assignee" required>
                                <option value="" disabled selected>-- Ch·ªçn nh√¢n s·ª± --</option>
                                <optgroup label="‚≠ê L√£nh ƒë·∫°o Khoa">
                                    <option value="Nguy·ªÖn Th·ªã H∆∞∆°ng Giang">DS.CKII Nguy·ªÖn Th·ªã H∆∞∆°ng Giang</option>
                                    <option value="Tr·∫ßn Th·ªã Huy·ªÅn Trang">DS.CKI Tr·∫ßn Th·ªã Huy·ªÅn Trang</option>
                                </optgroup>
                                <optgroup label="üíä T·ªï D∆∞·ª£c L√¢m S√†ng">
                                    <option value="Nguy·ªÖn Th·ªã H∆∞∆°ng Giang">Nguy·ªÖn Th·ªã H∆∞∆°ng Giang (T·ªï tr∆∞·ªüng)</option>
                                    <option value="Ph·∫°m B√° Th∆∞∆°ng">Ph·∫°m B√° Th∆∞∆°ng</option>
                                    <option value="Chu ƒê√†i Trang">Chu ƒê√†i Trang</option>
                                    <option value="L√™ Th·ªã Thanh Nh√†n">L√™ Th·ªã Thanh Nh√†n</option>
                                </optgroup>
                                <optgroup label="üì¶ T·ªï Kho">
                                    <option value="Nguy·ªÖn Duy Ti·∫øn">Nguy·ªÖn Duy Ti·∫øn (T·ªï tr∆∞·ªüng)</option>
                                    <option value="Nguy·ªÖn Th·ªã H·∫±ng">Nguy·ªÖn Th·ªã H·∫±ng</option>
                                    <option value="Ki·ªÅu M·∫°nh To√†n">Ki·ªÅu M·∫°nh To√†n</option>
                                    <option value="ƒê·ªó Th·ªã Nh·∫≠t L·ªá">ƒê·ªó Th·ªã Nh·∫≠t L·ªá</option>
                                    <option value="H√† Th·ªã Th·∫£o">H√† Th·ªã Th·∫£o</option>
                                    <option value="Nguy·ªÖn Tu·∫•n Th√†nh">Nguy·ªÖn Tu·∫•n Th√†nh</option>
                                    <option value="Nguy·ªÖn Th·ªã Thu H√†">Nguy·ªÖn Th·ªã Thu H√†</option>
                                </optgroup>
                                <optgroup label="üìä T·ªï Th·ªëng k√™ - Nghi·ªáp v·ª•">
                                    <option value="Tr·∫ßn Th·ªã Huy·ªÅn Trang">Tr·∫ßn Th·ªã Huy·ªÅn Trang (T·ªï tr∆∞·ªüng)</option>
                                    <option value="V≈© Th·ªã H·ªìng H·∫°nh">V≈© Th·ªã H·ªìng H·∫°nh</option>
                                </optgroup>
                                <optgroup label="üöö T·ªï Cung ·ª©ng">
                                    <option value="Nguy·ªÖn Th·ªã H∆∞∆°ng Giang">Nguy·ªÖn Th·ªã H∆∞∆°ng Giang</option>
                                    <option value="Tr·∫ßn Th·ªã Huy·ªÅn Trang">Tr·∫ßn Th·ªã Huy·ªÅn Trang</option>
                                    <option value="L√™ Th·ªã Thanh Nh√†n">L√™ Th·ªã Thanh Nh√†n</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">Tr·∫°ng th√°i</label>
                            <select class="form-select" name="status">
                                <option value="Todo">Todo (Ch·ªù)</option>
                                <option value="Doing" selected>Doing (ƒêang l√†m)</option>
                                <option value="Done">Done (Xong)</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">∆Øu ti√™n</label>
                            <select class="form-select" name="priority">
                                <option value="P1">üî¥ Cao</option>
                                <option value="P2" selected>üü° TB</option>
                                <option value="P3">üü¢ Th·∫•p</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="fw-bold">Deadline</label>
                            <input type="date" class="form-control" name="deadline">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold">Ti·∫øn ƒë·ªô: <span id="progressVal" class="text-success fw-bold">0%</span></label>
                        <input type="range" class="form-range" name="progress" min="0" max="100" step="10" value="0" oninput="document.getElementById('progressVal').innerText = this.value + '%'">
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold">Ghi ch√∫</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>

                    <button type="submit" class="btn btn-success w-100 fw-bold py-2" id="submitBtn">L∆ØU C√îNG VI·ªÜC</button>
                    <div id="message" class="text-center mt-2 fw-bold"></div>
                </form>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-list">
            <div class="card card-custom p-3">
                
                <div class="row g-2 mb-3 bg-light p-3 rounded">
                    <div class="col-md-4">
                        <label class="form-label fw-bold small">üîç L·ªçc theo t√™n ng∆∞·ªùi</label>
                        <select id="filterAssignee" class="form-select form-select-sm" onchange="renderTable()">
                            <option value="">-- T·∫•t c·∫£ nh√¢n vi√™n --</option>
                            </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">üìå L·ªçc tr·∫°ng th√°i</label>
                        <select id="filterStatus" class="form-select form-select-sm" onchange="renderTable()">
                            <option value="">-- T·∫•t c·∫£ --</option>
                            <option value="Todo">Todo (Ch∆∞a l√†m)</option>
                            <option value="Doing">Doing (ƒêang l√†m)</option>
                            <option value="Done">Done (Ho√†n th√†nh)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                         <label class="form-label fw-bold small">üìÖ T√¨m t√™n vi·ªác</label>
                         <input type="text" id="filterText" class="form-control form-control-sm" placeholder="Nh·∫≠p t·ª´ kh√≥a..." onkeyup="renderTable()">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary btn-sm w-100" onclick="loadTaskList()">üîÑ T·∫£i l·∫°i</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle border">
                        <thead class="table-light">
                            <tr>
                                <th width="35%">C√¥ng vi·ªác / Ti·∫øn ƒë·ªô</th>
                                <th width="20%">Ng∆∞·ªùi l√†m</th>
                                <th width="15%">H·∫°n ch√≥t</th>
                                <th width="15%">Tr·∫°ng th√°i</th>
                                <th width="15%">X√°c nh·∫≠n</th>
                            </tr>
                        </thead>
                        <tbody id="taskTableBody">
                            <tr><td colspan="5" class="text-center py-4">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="pills-report">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="card card-custom p-3 h-100">
                        <h6 class="text-center text-secondary fw-bold">T·ªâ l·ªá ho√†n th√†nh c√¥ng vi·ªác</h6>
                        <div id="piechart" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card card-custom p-3 h-100">
                        <h6 class="text-center text-secondary fw-bold">S·ªë l∆∞·ª£ng vi·ªác ƒë∆∞·ª£c giao</h6>
                        <div id="barchart_count" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-outline-primary" onclick="loadDashboard()">üîÑ C·∫≠p nh·∫≠t b√°o c√°o</button>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- C·∫§U H√åNH ---
    // H√ÉY D√ÅN LINK WEB APP C·ª¶A B·∫†N V√ÄO D∆Ø·ªöI ƒê√ÇY
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_9NKQHyVrnuNHs4hzRElnEpLILt6bubcMZkle6CUvo9NmV0VtXeulm_g7HzJnC7MqyQ/exec"; 

    let globalData = [];

    // 1. G·ª¨I FORM (ADD TASK)
    document.getElementById('taskForm').addEventListener('submit', e => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn'); 
        btn.disabled = true; btn.innerText = "ƒêang l∆∞u...";
        
        const formData = new FormData(document.getElementById('taskForm'));
        const data = Object.fromEntries(formData.entries());

        fetch(SCRIPT_URL + "?action=add", { method: 'POST', body: JSON.stringify(data) })
        .then(r => r.json()).then(res => {
            if(res.status === 'success') {
                alert("‚úÖ " + res.message);
                document.getElementById('taskForm').reset();
                document.getElementById('progressVal').innerText = "0%";
                // T·ª± ƒë·ªông chuy·ªÉn sang tab danh s√°ch ƒë·ªÉ xem vi·ªác v·ª´a t·∫°o
                document.querySelector('[data-bs-target="#pills-list"]').click();
            } else { alert("L·ªói: " + res.message); }
        })
        .catch(err => alert("L·ªói k·∫øt n·ªëi!"))
        .finally(() => { btn.disabled = false; btn.innerText = "L∆ØU C√îNG VI·ªÜC"; });
    });

    // 2. T·∫¢I D·ªÆ LI·ªÜU
    function loadTaskList() {
        if(SCRIPT_URL.includes("D√ÅN_LINK")) { alert("Ch∆∞a d√°n Link API!"); return; }
        
        const tbody = document.getElementById('taskTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-success"></div><br>ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheet...</td></tr>';

        fetch(SCRIPT_URL + "?action=read")
        .then(r => r.json()).then(res => {
            console.log("D·ªØ li·ªáu g·ªëc t·∫£i v·ªÅ:", res.data); // Xem log ƒë·ªÉ debug
            globalData = res.data; 
            populateAssigneeFilter(globalData);
            renderTable();
        })
        .catch(err => {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">L·ªói t·∫£i d·ªØ li·ªáu: ${err}</td></tr>`;
        });
    }

    // ƒêi·ªÅn t√™n v√†o b·ªô l·ªçc
    function populateAssigneeFilter(data) {
        const select = document.getElementById('filterAssignee');
        const currentVal = select.value;
        // L·ªçc l·∫•y danh s√°ch t√™n, lo·∫°i b·ªè d√≤ng tr·ªëng
        const people = [...new Set(data.map(row => String(row[7] || "").trim()).filter(n => n))].sort();
        
        select.innerHTML = '<option value="">-- T·∫•t c·∫£ nh√¢n vi√™n --</option>';
        people.forEach(p => {
            select.innerHTML += `<option value="${p}">${p}</option>`;
        });
        select.value = currentVal;
    }

    // --- H√ÄM V·∫º B·∫¢NG (ƒê√É N√ÇNG C·∫§P) ---
    function renderTable() {
        const tbody = document.getElementById('taskTableBody');
        tbody.innerHTML = "";
        
        // L·∫•y gi√° tr·ªã l·ªçc v√† chu·∫©n h√≥a (v·ªÅ ch·ªØ th∆∞·ªùng, b·ªè d·∫•u c√°ch)
        const fName = document.getElementById('filterAssignee').value.toLowerCase().trim();
        const fStatus = document.getElementById('filterStatus').value; // Todo, Doing, Done
        const fText = document.getElementById('filterText').value.toLowerCase().trim();

        let count = 0; // Bi·∫øn ƒë·∫øm s·ªë vi·ªác t√¨m th·∫•y

        // L·ªçc d·ªØ li·ªáu
        let filteredData = globalData.filter(row => {
            // L·∫•y d·ªØ li·ªáu t·ª´ row, chuy·ªÉn v·ªÅ chu·ªói ƒë·ªÉ tr√°nh l·ªói null
            let assignee = String(row[7] || "").toLowerCase().trim();
            let status = String(row[2] || "").trim(); // C·ªôt tr·∫°ng th√°i (Index 2)
            let taskName = String(row[1] || "").toLowerCase();

            // Logic so s√°nh
            const matchName = (fName === "" || assignee === fName);
            const matchText = (fText === "" || taskName.includes(fText));
            
            // So s√°nh tr·∫°ng th√°i (Quan tr·ªçng: X·ª≠ l√Ω l·ªèng l·∫ªo h∆°n)
            // N·∫øu l·ªçc l√† "Doing", n√≥ s·∫Ω ch·∫•p nh·∫≠n c·∫£ "Doing", "doing", "Doing "
            let matchStatus = true;
            if (fStatus !== "") {
                matchStatus = (status.toLowerCase() === fStatus.toLowerCase());
            }

            return matchName && matchStatus && matchText;
        });

        // S·∫Øp x·∫øp: Done xu·ªëng d∆∞·ªõi c√πng
        filteredData.sort((a,b) => {
            const statusA = String(a[2] || "").trim();
            const statusB = String(b[2] || "").trim();
            return (statusA === 'Done') - (statusB === 'Done');
        });

        // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
        if(filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted fst-italic py-3">Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác n√†o ph√π h·ª£p.<br><small>(H√£y ki·ªÉm tra l·∫°i c·ªôt Tr·∫°ng th√°i trong Google Sheet)</small></td></tr>';
            return;
        }

        // V·∫Ω t·ª´ng d√≤ng
        filteredData.forEach(row => {
            let id = row[0];
            let name = row[1];
            let rawStatus = String(row[2] || "").trim(); // L·∫•y tr·∫°ng th√°i g·ªëc
            let deadline = row[4] ? new Date(row[4]).toLocaleDateString('vi-VN') : '';
            let assignee = row[7];
            let progress = parseInt(String(row[8] || "0").replace('%','')) || 0;

            // X·ª≠ l√Ω m√†u s·∫Øc Badge
            let badgeClass = 'bg-secondary';
            if(rawStatus === 'Todo') badgeClass = 'bg-todo';
            else if(rawStatus === 'Doing') badgeClass = 'bg-doing';
            else if(rawStatus === 'Done') badgeClass = 'bg-done';

            // M√†u thanh ti·∫øn ƒë·ªô
            let barColor = progress === 100 ? 'bg-success' : (progress < 50 ? 'bg-danger' : 'bg-warning');

            // N√∫t b·∫•m
            let actionBtn = rawStatus !== 'Done' 
                ? `<button class="btn btn-outline-success btn-sm" onclick="markAsDone('${id}')">‚úÖ Xong</button>` 
                : `<span class="text-success fw-bold">‚úì</span>`;

            let tr = `<tr>
                <td>
                    <div class="fw-bold text-primary">${name}</div>
                    <small class="text-muted d-block fst-italic">${row[5] || ""}</small>
                    <div class="progress progress-sm w-100 bg-secondary-subtle">
                        <div class="progress-bar ${barColor}" style="width: ${progress}%"></div>
                    </div>
                </td>
                <td><span class="fw-bold text-dark">${assignee}</span></td>
                <td>${deadline}</td>
                <td><span class="badge badge-status ${badgeClass}">${rawStatus}</span></td>
                <td>${actionBtn}</td>
            </tr>`;
            tbody.innerHTML += tr;
            count++;
        });

        // Th√™m d√≤ng t·ªïng k·∫øt s·ªë l∆∞·ª£ng (ƒê·ªÉ b·∫°n bi·∫øt c√≥ bao nhi√™u vi·ªác)
        tbody.innerHTML += `<tr class="table-light"><td colspan="5" class="text-center text-secondary small fw-bold">Hi·ªÉn th·ªã ${count} c√¥ng vi·ªác</td></tr>`;
    }

    // 3. ƒê√ÅNH D·∫§U HO√ÄN TH√ÄNH
    function markAsDone(taskId) {
        if (!confirm("X√°c nh·∫≠n ho√†n th√†nh?")) return;
        const btn = event.target; btn.innerText = "..."; btn.disabled = true;

        fetch(SCRIPT_URL + "?action=update", {
            method: 'POST', body: JSON.stringify({ id: taskId })
        }).then(r => r.json()).then(res => {
            alert(res.message);
            loadTaskList(); 
        });
    }

    // 4. B√ÅO C√ÅO (DASHBOARD)
    google.charts.load('current', {'packages':['corechart', 'bar']});
    function loadDashboard() {
        if(SCRIPT_URL.includes("D√ÅN_LINK")) { alert("Ch∆∞a d√°n Link API!"); return; }
        fetch(SCRIPT_URL + "?action=read").then(r => r.json()).then(res => {
            drawCharts(res.data);
        });
    }

    function drawCharts(data) {
        if(!data || data.length === 0) return;

        var statusCount = {'Todo': 0, 'Doing': 0, 'Done': 0};
        var personStats = {}; 

        data.forEach(row => {
            let status = String(row[2] || "").trim(); // Chu·∫©n h√≥a status
            let person = row[7];
            
            if(statusCount[status] !== undefined) statusCount[status]++;
            // N·∫øu trong sheet c√≥ status l·∫° (v√≠ d·ª• "ƒêang l√†m"), g·ªôp n√≥ v√†o Doing ho·∫∑c t·∫°o nh√≥m m·ªõi
            else {
                 // T√πy ch·ªçn: G·ªôp c√°c status l·∫° v√†o
                 statusCount['Doing'] = (statusCount['Doing'] || 0) + 1;
            }

            if(person) {
                if(!personStats[person]) personStats[person] = { count: 0 };
                personStats[person].count++;
            }
        });

        var pieData = google.visualization.arrayToDataTable([
            ['Tr·∫°ng th√°i', 'S·ªë l∆∞·ª£ng'],
            ['Todo', statusCount['Todo']], ['Doing', statusCount['Doing']], ['Done', statusCount['Done']]
        ]);
        new google.visualization.PieChart(document.getElementById('piechart')).draw(pieData, {
            colors: ['#dc3545', '#ffc107', '#198754'], is3D: true, legend: {position:'bottom'}
        });

        var countArray = [['Nh√¢n vi√™n', 'S·ªë vi·ªác', { role: 'style' }]];
        Object.keys(personStats).sort().forEach(p => {
            countArray.push([p, personStats[p].count, '#0d6efd']);
        });
        new google.visualization.ColumnChart(document.getElementById('barchart_count')).draw(
            google.visualization.arrayToDataTable(countArray), 
            { legend: { position: "none" }, vAxis: {title: 'S·ªë l∆∞·ª£ng ƒë·∫ßu vi·ªác'} }
        );
    }
</script>

</body>
</html>
